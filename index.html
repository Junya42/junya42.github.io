<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prism Global Diagnostics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --accent: #0070f3;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --disabled: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        h1 { margin-bottom: 5px; }
        p { color: #888; margin-bottom: 30px; }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1100px;
            align-items: center;
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        button:hover { opacity: 0.9; }
        
        button.secondary { background-color: var(--card-bg); border: 1px solid #444; }
        
        button:disabled { 
            background-color: var(--disabled); 
            color: #888; 
            border-color: transparent;
            cursor: not-allowed; 
            opacity: 0.7;
        }

        .progress-wrapper {
            flex-grow: 1;
            display: none;
            align-items: center;
            gap: 15px;
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #444;
        }

        .progress-track {
            flex-grow: 1;
            height: 10px;
            background-color: #444;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--accent);
            transition: width 0.3s ease-out;
            box-shadow: 0 0 10px rgba(0, 112, 243, 0.5);
        }

        .progress-text {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--accent);
            min-width: 50px;
            text-align: right;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #404040; }
        
        th {
            background-color: #333;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }

        tr:last-child td { border-bottom: none; }
        tr[data-region="eu-west-3"] { background-color: rgba(255, 255, 255, 0.05); }

        .ping-cell { font-family: 'Courier New', monospace; font-size: 1em; color: #aaa; }
        .highlight { color: #fff; font-weight: bold; }
        .val { display: inline-block; width: 30px; text-align: right; font-size: 0.9em; }
        .sep { color: #444; margin: 0 1px; }

        .good { color: var(--success); }
        .avg { color: var(--warning); }
        .bad { color: var(--danger); }
        .jitter-good { color: #888; font-size: 0.8em; }
        .jitter-bad { color: var(--danger); font-weight: bold; }

        /* 3D TEST OVERLAY */
        #three-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            z-index: 999;
        }
        #three-ui {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-align: center;
            pointer-events: none;
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }
        .ui-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: var(--accent); }
        .ui-sub { font-size: 1rem; color: #aaa; }
        .ui-timer { font-size: 2rem; font-weight: bold; margin-top: 10px; font-family: 'Courier New', monospace; }
        .ui-live { font-size: 0.9em; color: var(--success); margin-top: 5px; }
    </style>
</head>
<body>

    <h1>System & Network Diagnostics</h1>
    <p>10s GPU Stress Test + Parallel Network Latency Analysis.</p>

    <div class="controls">
        <button onclick="runAllTests()" id="btn-run">Start Full Diagnostics</button>
        
        <div class="progress-wrapper" id="progress-container">
            <span style="font-size:0.9em; color:#aaa;" id="progress-status">Testing...</span>
            <div class="progress-track">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
            <span class="progress-text" id="progress-percent">0%</span>
        </div>

        <button onclick="exportResults()" id="btn-export" class="secondary" disabled title="Click Start first">Copy Report</button>
    </div>

    <div class="container">
        <table id="results-table">
            <thead>
                <tr>
                    <th>Region</th>
                    <th>Samples (7)</th>
                    <th>Avg Latency</th>
                    <th>Jitter</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>

    <div id="three-overlay">
        <div id="three-ui">
            <div class="ui-title">STRESS TESTING GPU</div>
            <div class="ui-sub">Simulating heavy load (500 objects) + Network Pings</div>
            <div class="ui-timer" id="fps-timer">10.0s</div>
            <div class="ui-live" id="fps-live">Wait...</div>
        </div>
    </div>

    <script>
        // FULL LIST RESTORED
        const endpoints = [
            // EUROPE
            { name: "Europe (Paris)", code: "eu-west-3", url: "https://dynamodb.eu-west-3.amazonaws.com/ping" },
            { name: "Europe (Ireland)", code: "eu-west-1", url: "https://dynamodb.eu-west-1.amazonaws.com/ping" },
            { name: "Europe (London)", code: "eu-west-2", url: "https://dynamodb.eu-west-2.amazonaws.com/ping" },
            { name: "Europe (Frankfurt)", code: "eu-central-1", url: "https://dynamodb.eu-central-1.amazonaws.com/ping" },
            { name: "Europe (Stockholm)", code: "eu-north-1", url: "https://dynamodb.eu-north-1.amazonaws.com/ping" },
            { name: "Europe (Milan)", code: "eu-south-1", url: "https://dynamodb.eu-south-1.amazonaws.com/ping" },
            { name: "Europe (Spain)", code: "eu-south-2", url: "https://dynamodb.eu-south-2.amazonaws.com/ping" },
            
            // NORTH AMERICA
            { name: "US East (N. Virginia)", code: "us-east-1", url: "https://dynamodb.us-east-1.amazonaws.com/ping" },
            { name: "US East (Ohio)", code: "us-east-2", url: "https://dynamodb.us-east-2.amazonaws.com/ping" },
            { name: "US West (N. California)", code: "us-west-1", url: "https://dynamodb.us-west-1.amazonaws.com/ping" },
            { name: "US West (Oregon)", code: "us-west-2", url: "https://dynamodb.us-west-2.amazonaws.com/ping" },
            { name: "Canada (Central)", code: "ca-central-1", url: "https://dynamodb.ca-central-1.amazonaws.com/ping" },
            
            // SOUTH AMERICA
            { name: "South America (São Paulo)", code: "sa-east-1", url: "https://dynamodb.sa-east-1.amazonaws.com/ping" },
            
            // ASIA PACIFIC
            { name: "Asia Pacific (Tokyo)", code: "ap-northeast-1", url: "https://dynamodb.ap-northeast-1.amazonaws.com/ping" },
            { name: "Asia Pacific (Seoul)", code: "ap-northeast-2", url: "https://dynamodb.ap-northeast-2.amazonaws.com/ping" },
            { name: "Asia Pacific (Singapore)", code: "ap-southeast-1", url: "https://dynamodb.ap-southeast-1.amazonaws.com/ping" },
            { name: "Asia Pacific (Sydney)", code: "ap-southeast-2", url: "https://dynamodb.ap-southeast-2.amazonaws.com/ping" },
            { name: "Asia Pacific (Mumbai)", code: "ap-south-1", url: "https://dynamodb.ap-south-1.amazonaws.com/ping" },
            { name: "Asia Pacific (Hyderabad)", code: "ap-south-2", url: "https://dynamodb.ap-south-2.amazonaws.com/ping" },
            { name: "Asia Pacific (Hong Kong)", code: "ap-east-1", url: "https://dynamodb.ap-east-1.amazonaws.com/ping" },
            
            // MIDDLE EAST & AFRICA
            { name: "Middle East (UAE)", code: "me-central-1", url: "https://streams.dynamodb.me-central-1.amazonaws.com/ping" },
            { name: "Africa (Cape Town)", code: "af-south-1", url: "https://dynamodb.af-south-1.amazonaws.com/ping" }
        ];

        const tbody = document.getElementById('table-body');
        let results = {};
        
        let hardwareInfo = {
            gpu: "Unknown GPU",
            gpuVendor: "Unknown Vendor",
            cpuCores: navigator.hardwareConcurrency || "Unknown",
            ram: navigator.deviceMemory ? `~${navigator.deviceMemory} GB` : "Unknown",
            screen: `${window.screen.width}x${window.screen.height}`,
            userAgent: navigator.userAgent,
            fpsMin: 0,
            fpsMax: 0,
            fpsAvg: 0
        };
        
        let networkInfo = { ip: "Checking...", city: "Checking...", country: "Checking...", isp: "Checking..." };

        function detectGPU() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                if (gl) {
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        hardwareInfo.gpuVendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                        hardwareInfo.gpu = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    }
                }
            } catch (e) { console.error("GPU detection failed", e); }
        }

        async function fetchNetworkInfo() {
            try {
                const response = await fetch('https://ipwho.is/');
                if(response.ok) {
                    const data = await response.json();
                    if(data.success) {
                        networkInfo.ip = data.ip;
                        networkInfo.city = data.city;
                        networkInfo.country = data.country;
                        networkInfo.isp = data.connection.isp;
                    } else { networkInfo.city = "Failed"; }
                }
            } catch (e) { networkInfo.city = "Adblock/Error"; }
        }

        // --- THREE.JS BENCHMARK LOGIC (10s Duration) ---
        function runThreeJSTest() {
            return new Promise(resolve => {
                const overlay = document.getElementById('three-overlay');
                const timerEl = document.getElementById('fps-timer');
                const liveEl = document.getElementById('fps-live');
                overlay.style.display = 'block';

                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x111111);
                scene.fog = new THREE.Fog(0x111111, 20, 100);

                const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 40, 40);
                camera.lookAt(0, 0, 0);

                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                overlay.appendChild(renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0x404040); 
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                dirLight.position.set(10, 50, 20);
                scene.add(dirLight);

                const gridHelper = new THREE.GridHelper(100, 50, 0x0070f3, 0x333333);
                scene.add(gridHelper);

                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshPhongMaterial({ color: 0x444444, flatShading: true });
                
                for (let i = 0; i < 600; i++) { 
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.x = (Math.random() - 0.5) * 80;
                    mesh.position.y = Math.random() * 10;
                    mesh.position.z = (Math.random() - 0.5) * 80;
                    mesh.rotation.x = Math.random() * Math.PI;
                    mesh.rotation.y = Math.random() * Math.PI;
                    scene.add(mesh);
                }

                const playerGeo = new THREE.SphereGeometry(1.5, 32, 32);
                const playerMat = new THREE.MeshBasicMaterial({ color: 0x0070f3 });
                const player = new THREE.Mesh(playerGeo, playerMat);
                scene.add(player);

                const path = [
                    new THREE.Vector3(-30, 2, -30), 
                    new THREE.Vector3(30, 2, -30),
                    new THREE.Vector3(30, 2, 30),
                    new THREE.Vector3(-30, 2, 30),
                    new THREE.Vector3(0, 2, 0)
                ];
                let currentTargetIndex = 0;
                
                let startTime = performance.now();
                let lastTime = startTime;
                let frames = 0;
                let fpsValues = [];
                let animationId;
                const totalDuration = 10000; 

                function animate() {
                    const now = performance.now();
                    frames++;

                    if (now - lastTime >= 500) {
                        const fps = Math.round((frames * 1000) / (now - lastTime));
                        fpsValues.push(fps);
                        liveEl.innerText = `Current: ${fps} FPS`;
                        frames = 0;
                        lastTime = now;
                    }

                    const elapsed = now - startTime;
                    const remaining = Math.max(0, (totalDuration - elapsed) / 1000).toFixed(1);
                    timerEl.innerText = remaining + "s";

                    if (elapsed >= totalDuration) {
                        cancelAnimationFrame(animationId);
                        
                        if (fpsValues.length > 0) {
                            hardwareInfo.fpsMin = Math.min(...fpsValues);
                            hardwareInfo.fpsMax = Math.max(...fpsValues);
                            hardwareInfo.fpsAvg = Math.round(fpsValues.reduce((a,b)=>a+b,0) / fpsValues.length);
                        } else {
                            hardwareInfo.fpsAvg = 60; 
                        }

                        renderer.dispose();
                        overlay.style.display = 'none';
                        resolve();
                        return;
                    }

                    const target = path[currentTargetIndex];
                    const direction = new THREE.Vector3().subVectors(target, player.position);
                    const dist = direction.length();

                    if (dist < 1) {
                        currentTargetIndex = (currentTargetIndex + 1) % path.length;
                    } else {
                        direction.normalize();
                        player.position.add(direction.multiplyScalar(0.8));
                    }
                    
                    camera.position.x += (player.position.x - camera.position.x) * 0.05;
                    camera.position.z += (player.position.z + 40 - camera.position.z) * 0.05;
                    camera.lookAt(player.position);

                    renderer.render(scene, camera);
                    animationId = requestAnimationFrame(animate);
                }

                animate();
            });
        }

        // --- NETWORK TEST LOGIC ---
        function initTable() {
            detectGPU();
            tbody.innerHTML = '';
            endpoints.forEach(ep => {
                const tr = document.createElement('tr');
                tr.dataset.region = ep.code;
                tr.innerHTML = `
                    <td>${ep.name}</td>
                    <td class="ping-cell" id="samples-${ep.code}">-</td>
                    <td class="ping-cell highlight" id="avg-${ep.code}">-</td>
                    <td class="ping-cell" id="jitter-${ep.code}">-</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function measurePing(url) {
            const start = performance.now();
            try {
                await fetch(url + '?t=' + Date.now(), { mode: 'no-cors', cache: 'no-store' });
                return Math.round(performance.now() - start);
            } catch (e) { return null; }
        }

        function updateProgress(current, total, status) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = percent + '%';
            if(status) document.getElementById('progress-status').innerText = status;
        }

        async function runNetworkTests() {
            // STEP 1: SAFETY WAIT (Avoid fetching heavy JS interference)
            updateProgress(0, endpoints.length, "Stabilizing Network (3s)...");
            await new Promise(r => setTimeout(r, 3000));

            // STEP 2: START PINGING
            for (let i = 0; i < endpoints.length; i++) {
                const ep = endpoints[i];
                const cellSamples = document.getElementById(`samples-${ep.code}`);
                const cellAvg = document.getElementById(`avg-${ep.code}`);
                const cellJitter = document.getElementById(`jitter-${ep.code}`);
                
                updateProgress(i + 1, endpoints.length, `Testing ${ep.name}...`);
                
                // Warmup
                await measurePing(ep.url);
                await new Promise(r => setTimeout(r, 100));

                let measures = [];
                let displayHtml = "";

                for(let j=0; j<7; j++) {
                    const time = await measurePing(ep.url);
                    if (time !== null) {
                        measures.push(time);
                        displayHtml += `<span class="val">${time}</span>`;
                    } else { displayHtml += `<span class="val bad">Err</span>`; }
                    
                    if(j < 6) displayHtml += `<span class="sep">|</span>`;
                    cellSamples.innerHTML = displayHtml;
                    
                    await new Promise(r => setTimeout(r, 200));
                }

                if (measures.length > 0) {
                    const sum = measures.reduce((a, b) => a + b, 0);
                    const avg = Math.round(sum / measures.length);
                    const jitter = Math.max(...measures) - Math.min(...measures);

                    results[ep.name] = { values: measures, avg: avg, jitter: jitter };
                    
                    cellAvg.innerText = avg + " ms";
                    let colorClass = "bad";
                    if (avg < 60) colorClass = "good"; else if (avg < 150) colorClass = "avg";
                    cellAvg.className = "ping-cell highlight " + colorClass;

                    cellJitter.innerText = `±${jitter}ms`;
                    if(jitter < 10) cellJitter.className = "ping-cell jitter-good"; 
                    else if(jitter < 30) cellJitter.className = "ping-cell avg";
                    else cellJitter.className = "ping-cell jitter-bad";
                } else { cellAvg.innerText = "Error"; }
            }
        }

        // MAIN EXECUTION
        async function runAllTests() {
            const btnRun = document.getElementById('btn-run');
            const btnExport = document.getElementById('btn-export');
            const progressContainer = document.getElementById('progress-container');
            
            btnRun.style.display = 'none';
            progressContainer.style.display = 'flex';
            btnExport.disabled = true;
            btnExport.title = "Wait for tests to finish";
            
            updateProgress(0, endpoints.length, "Starting Parallel Tests...");
            results = {};
            fetchNetworkInfo();

            endpoints.forEach(ep => {
                document.getElementById(`samples-${ep.code}`).innerText = '-';
                document.getElementById(`avg-${ep.code}`).innerText = '-';
                document.getElementById(`jitter-${ep.code}`).innerText = '-';
                document.getElementById(`avg-${ep.code}`).className = 'ping-cell highlight';
            });

            // PARALLEL EXECUTION
            await Promise.all([
                runThreeJSTest(), 
                runNetworkTests() 
            ]);

            updateProgress(endpoints.length, endpoints.length, "Diagnostics Complete!");
            progressContainer.style.display = 'none';
            btnRun.style.display = 'block';
            btnRun.innerText = "Restart Diagnostics";
            btnExport.disabled = false;
            btnExport.title = "";
        }

        function exportResults() {
            if (Object.keys(results).length === 0) return;
            const now = new Date().toISOString();
            
            let text = `=== PRISM DIAGNOSTIC REPORT ===\n`;
            text += `Date: ${now}\n\n`;

            text += `--- HARDWARE & BENCHMARK (10s Stress Test) ---\n`;
            text += `GPU: ${hardwareInfo.gpu}\n`;
            text += `FPS Stats: Avg ${hardwareInfo.fpsAvg} | Min ${hardwareInfo.fpsMin} | Max ${hardwareInfo.fpsMax}\n`;
            text += `CPU Cores: ${hardwareInfo.cpuCores}\n`;
            text += `RAM: ${hardwareInfo.ram}\n`;
            text += `Screen: ${hardwareInfo.screen}\n`;
            text += `Browser: ${hardwareInfo.userAgent}\n\n`;

            text += `--- NETWORK INFO ---\n`;
            text += `ISP: ${networkInfo.isp}\n`;
            text += `Location: ${networkInfo.city}, ${networkInfo.country}\n`;
            text += `IP: ${networkInfo.ip}\n\n`;
            
            text += `--- LATENCY & JITTER ---\n`;
            const sortedKeys = Object.keys(results).sort((a,b) => results[a].avg - results[b].avg);
            
            sortedKeys.forEach(key => {
                const data = results[key];
                const allPings = data.values.join(" | ");
                text += `[Avg: ${data.avg}ms | Jitter: ±${data.jitter}ms] ${key} : ${allPings}\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('btn-export');
                const originalText = btn.innerText;
                btn.innerText = "Report Copied!";
                setTimeout(() => btn.innerText = originalText, 2000);
            });
        }

        initTable();
    </script>
</body>
</html>